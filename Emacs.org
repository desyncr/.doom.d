#+TITLE: Emacs doom configuration
#+LANGUAGE: en
#+PROPERTY: header-args :tangle config.el :cache yes :results silent :auto_tangle yes
#+STARTUP: inlineimages

#+ATTR_HTML: :style margin-left: auto; margin-right: auto;
[[./splash/doom-emacs-bw-light.svg]]
* Table of Contents :TOC:
- [[#general][General]]
  - [[#keyboard][Keyboard]]
  - [[#files][Files]]
- [[#ui][UI]]
  - [[#fonts][Fonts]]
  - [[#os-theme-sync][OS theme sync]]
  - [[#splash-image][Splash image]]
  - [[#vertico][vertico]]
  - [[#vertico-repeat][vertico-repeat]]
  - [[#vertico-posframe][vertico-posframe]]
  - [[#center-isearch][center-isearch]]
  - [[#centered-cursor-mode][centered-cursor-mode]]
  - [[#resize-window][resize-window]]
  - [[#split-windows][Split windows]]
  - [[#toggle-maximize][Toggle maximize]]
  - [[#highlight-indent-guides][highlight-indent-guides]]
  - [[#prompt-for-buffer][prompt-for-buffer]]
  - [[#consult][consult]]
  - [[#display-time][Display time]]
  - [[#doom-modeline][Doom modeline]]
- [[#keybindings][Keybindings]]
  - [[#navigation-and-files][Navigation and files]]
  - [[#buffers-and-edition][Buffers and Edition]]
- [[#writing][Writing]]
  - [[#spell-checking][Spell checking]]
- [[#coding][Coding]]
  - [[#smart-parens][smart-parens]]
  - [[#expand-region][expand-region]]
  - [[#syntax-entry][syntax-entry]]
  - [[#flycheck][flycheck]]
  - [[#lsp][lsp]]
  - [[#rainbow-delimiters-mode][rainbow-delimiters-mode]]
  - [[#yasnippets][yasnippets]]
  - [[#devdocs][devdocs]]
  - [[#better-jumper][better-jumper]]
  - [[#avy][avy]]
  - [[#multiple-cursors][multiple-cursors]]
- [[#version-control][Version control]]
  - [[#git][Git]]
  - [[#magit][Magit]]
- [[#project-management][Project management]]
  - [[#projectile][projectile]]
  - [[#treemacs][treemacs]]
  - [[#workspaces][workspaces]]
  - [[#ranger][ranger]]
- [[#org-everything][Org everything]]
  - [[#org-mode][org-mode]]
  - [[#org-capture][org-capture]]
  - [[#org-agenda][org-agenda]]
  - [[#org-modern][org-modern]]
  - [[#org-babel][org-babel]]
  - [[#org-roam][org-roam]]
  - [[#org-todo-keywords][org-todo-keywords]]
  - [[#org-bullets][org-bullets]]
  - [[#org-log-repeat][org-log-repeat]]
  - [[#toc-org][toc-org]]
  - [[#literate-calc-mode][literate-calc-mode]]
  - [[#org-pomodoro][org-pomodoro]]
  - [[#ox-slack][ox-slack]]
- [[#terminal-integration][Terminal integration]]
- [[#other][Other]]
  - [[#elfeed][elfeed]]
  - [[#browse-url][browse-url]]
  - [[#keyfreq][keyfreq]]

* General
This section contains custom packages and package configurations. Most of the configurations here are copy/pasted from the package repositories README.md or other sources. I added attribution/source wherever possible.

Since this is a literate configuration I'm making sure no body edits the resulting tangled configuration manually:
#+name: org-babel-warning-message
#+begin_src emacs-lisp
;; THIS FILE WAS GENERATED AUTOMATICALLY VIA org-babel. DO NOT EDIT MANUALLY.
#+end_src

Similarly I'll do the same for the =package.el= file:
#+begin_src emacs-lisp :noweb yes :tangle packages.el
<<org-babel-warning-message>>
#+end_src
In the above code block I'm using =:noweb yes=. This flag tells babel to use the referenced src block via the ~<< .. >>~  syntax, replacing the tag with the result of the referenced source block.

Some functionality uses this to identify you, e.g. GPG configuration, email clients, file templates and snippets. It is optional.

#+begin_src emacs-lisp
(setq user-full-name "DC*"
      user-mail-address "des@riseup.net")
#+end_src

Switch to normal mode on save:
#+begin_src emacs-lisp
(add-hook 'after-save-hook #'evil-normal-state)
#+end_src

Disable this warning message that appears from time to time:

#+begin_src emacs-lisp
(setq warning-suppress-types (append warning-suppress-types '((org-element-cache))))
#+end_src

See [[https://github.com/nobiot/org-transclusion/issues/105][this]] github issue for a possible cause of the warning.

** Keyboard
Explicitly define the Mac modifiers:

#+begin_src emacs-lisp
(setq mac-command-modifier 'meta) ; make cmd key do Meta
(setq mac-option-modifier 'super) ; make opt key do Super
(setq mac-control-modifier 'control) ; make Control key do Control
#+end_src
Source: [[http://xahlee.info/emacs/emacs/emacs_hyper_super_keys.html][here]].

** Files
Allow deleting files in OSX. Source: [[https://emacs.stackexchange.com/a/15012][Emacs' StackExchange]]

#+begin_src emacs-lisp
(setq delete-by-moving-to-trash t)
(setq trash-directory "~/.Trash")
#+end_src

*Also required*: Go to Settings -> Security & Privacy -> Privacy -> Automation and Allow Emacs -> Finder. Source: [[https://ajar.freshdesk.com/support/solutions/articles/26000045119-install-error-not-authorized-to-send-apple-events-to-system-events-][freshdesk.com]]

Archive entries in sub-directory. Source: [[https://emacs.stackexchange.com/a/25020][Emacs' StackExchange]]
*** undo-tree
This package is activated via =:emacs (undo +tree)=.

#+begin_src emacs-lisp
(use-package undo-tree
    :init
    (setq undo-limit 1000)
    (setq undo-outer-limit 1000)
    (setq undo-strong-limit 1500)
    (setq undo-tree-mode-lighter " UN")
    (setq undo-tree-auto-save-history t)
    (setq undo-tree-enable-undo-in-region nil)
    (setq undo-tree-history-directory-alist '(("." . "~/emacs.d/undo")))
    (add-hook 'undo-tree-visualizer-mode-hook
              (lambda () (undo-tree-visualizer-selection-mode)
                (setq display-line-numbers nil)))
    (add-hook 'evil-local-mode-hook 'turn-on-undo-tree-mode)
    :config
        (global-undo-tree-mode 1))
#+end_src
*** super-save
Automatically save open buffers on certain events.

#+begin_src emacs-lisp :tangle packages.el
(package! super-save)
#+end_src

Package repository: [[https://github.com/bbatsov/super-save][here]].

#+begin_src emacs-lisp
(use-package super-save
  :defer t
  :config
  (super-save-mode +1))
#+end_src

Super-save/lsp-mode were causing issues while typing. When a function call was typed (e.g. =call-to-func(=), lsp-mode would show the signature in the echo area, this will in turn cause super-save to save the file - as it lost focus - and switch to normal mode via the ~after-save-hook~ configured in the General section.

#+begin_src emacs-lisp
(defun me/super-save-disable-advice (orig-fun &rest args)
  "Dont auto-save under these conditions."
  (unless (equal (car args) " *LV*")
	(apply orig-fun args)))
(advice-add 'super-save-command-advice :around #'me/super-save-disable-advice)
#+end_src

Source: [[https://github.com/bbatsov/super-save/issues/38#issuecomment-1229537100][github comment]].
* UI
There are two ways to load a theme. Both assume the theme is installed and available. You can either set ~doom-theme~ or manually load a theme with the ~load-theme~ function. This is the default:

#+begin_src emacs-lisp
(setq doom-theme 'doom-nord-light)
#+end_src

*NOTE*: Under the UI section you'll see a configuration for synchronising Emacs theme (dark/light) with the OS.

This determines the style of line numbers in effect. If set to ~nil~, line numbers are disabled. For relative line numbers, set this to ~relative~.

#+begin_src emacs-lisp
(setq display-line-numbers-type t)
#+end_src

Configure emacs to turn fullscreen/maximized on startup:

#+begin_src emacs-lisp
(add-to-list 'default-frame-alist '(fullscreen . maximized))
#+end_src

Add word count to status/modeline. Useful for org documents and writing in general.

#+begin_src emacs-lisp
(setq doom-modeline-enable-word-count t)
#+end_src
** Fonts
Doom exposes five (optional) variables for controlling fonts in Doom:

- ~doom-font~ -- the primary font to use
- ~doom-variable-pitch-font~ -- a non-monospace font (where applicable)
- ~doom-big-font~ -- used for ~doom-big-font-mode~; use this for presentations or streaming.
- ~doom-unicode-font~ -- for unicode glyphs
- ~doom-serif-font~ -- for the ~fixed-pitch-serif~ face

See ~C-h v doom-font~ for documentation and more examples of what they accept. For example:

If you or Emacs can't find your font, use ~M-x describe-font~ to look them up, ~M-x eval-region~ to execute elisp code, and ~M-x doom/reload-font~ to refresh your font settings. If Emacs still can't find your font, it likely wasn't installed correctly. Font issues are rarely Doom issues!

I'm using the following fonts at the moment. Nothing in particular about these fonts, only that they support glyphs and ligatures.

#+begin_src emacs-lisp
(setq doom-font-increment 1)
(setq me/doom-font-size 12)
(setq me/doom-variable-font-size 13)
(setq doom-font (font-spec :family "JetBrainsMono Nerd Font" :size me/doom-font-size)) ;; Fira Code,  :weight 'medium, :size 12
(setq doom-unicode-font (font-spec :family "JetBrainsMono Nerd Font" :size me/doom-font-size))
(setq doom-variable-pitch-font (font-spec :family "Fira Sans" :size me/doom-variable-font-size))
#+end_src

Instructions to install ~Fira Code~ can be found [[https://github.com/tonsky/FiraCode/wiki/Installing][here]]. Install =Fira Sans= via brew:
#+begin_example bash
brew tap homebrew/cask-fonts
brew install --cask font-fira-sans
#+end_example
Source: [[https://gist.github.com/muammar/a5ffb635eb7f532346a8e777b847f8a7?permalink_comment_id=3609035#gistcomment-3609035][gist comment]].

Run the following command to install ~JetBrains Mono Nerd Font~:
#+begin_example
brew install --cask font-jetbrains-mono-nerd-font
#+end_example

You can install other fonts with a similar command following [[https://github.com/ryanoasis/nerd-fonts#option-4-homebrew-fonts][these]] instructions. See comment [[https://www.reddit.com/r/DoomEmacs/comments/qqqbon/comment/hrlhkzn/?utm_source=share&utm_medium=web2x&context=3][here]] and more info can be found [[https://github.com/ryanoasis/nerd-fonts/blob/master/patched-fonts/JetBrainsMono/font-info.md][here]] as well.
*** Font faces
#+begin_src emacs-lisp tangle:yes
(custom-set-faces
    '(line-number ((t (:foreground "#6f7787" :weight normal :slant normal))))
    '(line-number-current-line ((t (:foreground "#AEBACF" :weight normal :slant normal))))
    '(consult-separator ((t (:foreground "#AEBACF" :weight normal :slant normal))))
    '(consult-grep-context ((t (:foreground "#AEBACF" :weight normal :slant normal))))

    '(org-block ((t (:inherit fixed-pitch))))
    '(org-code ((t (:inherit (shadow fixed-pitch)))))
    '(org-document-info ((t (:foreground "dark orange"))))
    '(org-document-info-keyword ((t (:inherit (shadow fixed-pitch)))))
    '(org-indent ((t (:inherit (org-hide fixed-pitch)))))
    ;;'(org-link ((t (:foreground "royal blue" :underline t))))
    '(org-meta-line ((t (:inherit (font-lock-comment-face fixed-pitch)))))
    '(org-property-value ((t (:inherit fixed-pitch))) t)
    '(org-special-keyword ((t (:inherit (font-lock-comment-face fixed-pitch)))))
    '(org-table ((t (:inherit fixed-pitch :foreground "#83a598"))))
    '(org-tag ((t (:inherit (shadow fixed-pitch) :weight bold))))

    '(org-verbatim ((t (:inherit (shadow fixed-pitch))))))
#+end_src

** OS theme sync
Emacs plus build supports OS integration for [[https://github.com/d12frosted/homebrew-emacs-plus#system-appearance-change][light/dark theme switching]].

#+begin_src emacs-lisp
(setq me/appearance-dark 'doom-nord)
(setq me/appearance-light 'doom-nord-light)
#+end_src

#+begin_src emacs-lisp :tangle packages.el
(package! auto-dark)
#+end_src

#+begin_src emacs-lisp
(use-package auto-dark
  :init
    (auto-dark-mode t)
  :config
    (setq
      auto-dark-dark-theme me/appearance-dark
      auto-dark-light-theme me/appearance-light))
#+end_src

Add an interactive command to change appearance:
#+begin_src emacs-lisp
(defun me/switch-dark-appearance ()
    "Swith to current theme's dark appearance."
    (interactive)
    (mapc #'disable-theme custom-enabled-themes)
    (load-theme me/appearance-dark t))

(defun me/switch-light-appearance ()
    "Swith to current theme's light appearance."
    (interactive)
    (mapc #'disable-theme custom-enabled-themes)
    (load-theme me/appearance-light t))
#+end_src

This will not work on non-Mac OSes. But [[https://github.com/doomemacs/doomemacs/issues/6424#issue-1251604264][here's]] way to do it.
** Splash image
Configure Doom Emacs splash image. Taken from [[https://gitlab.com/zzamboni/dot-doom/-/tree/master/splash][zzamboni/dot-doom]]. Alternative splash images can be found at [[https://github.com/jeetelongname/doom-banners][jeetelongname/doom-banners]] repository.

#+begin_src emacs-lisp
(setq fancy-splash-image "~/.doom.d/splash/doom-emacs-bw-light.svg")
#+end_src

You can have Emacs display image inline via ~#+STARTUP: inlineimages~. See the top of this document for an example.
** TODO vertico
#+begin_src emacs-lisp
(use-package vertico
  :init
  (vertico-mode))
;; Persist history over Emacs restarts. Vertico sorts by history position.
(use-package savehist
  :defer t
  :init
  (savehist-mode))

;; Optionally use the `orderless' completion style.
(use-package orderless
  :defer t
  :init
  ;; Configure a custom style dispatcher (see the Consult wiki)
  ;; (setq orderless-style-dispatchers '(+orderless-dispatch)
  ;;       orderless-component-separator #'orderless-escapable-split-on-space)
  (setq completion-styles '(orderless basic)
        completion-category-defaults nil
        completion-category-overrides '((file (styles partial-completion)))))
#+end_src

The above snippet configures orderless, which enabled searching by keywords in whatever order.
** vertico-repeat
Vertico-repeat but for last command in category, e.g. last =+default/search-project= or last =consult-projectile=:
#+begin_src emacs-lisp
(setq vertico-repeat-history '())

; Remember empty completions
;(setq vertico-repeat-transformers
;    (list #'vertico-repeat--filter-commands #'vertico-repeat--filter-empty))

(defun me/vertico-filter-repeat-command (command)
  (-filter (lambda (x) (eq (car x) command)) vertico-repeat-history))

(defun me/vertico-repeat-last-command (cmd)
  (interactive)

  (setq session (car (me/vertico-filter-repeat-command cmd)))
  (if (eq session nil) (setq session (list cmd "")))

  (minibuffer-with-setup-hook
    (apply-partially #'vertico-repeat--restore session)
    (command-execute (setq this-command (car session)))))
#+end_src
** vertico-posframe
=Ctrl+P= / command launcher-like for =M-x=. This package is installed via [[doom-module:vertico +childframe]].

#+begin_src emacs-lisp
(use-package vertico-posframe
  :config
  (vertico-posframe-mode 1)
  (setq vertico-posframe-border-width 8
        vertico-posframe-width 120
        vertico-posframe-height 20
        vertico-posframe-min-height 20
        vertico-posframe-parameters
        '((left-fringe . 2)
          (right-fringe . 2))))
#+end_src

Function to quickly reset ~vertico-posframe~ when it gets offset for some reason and text gets cut off:
#+begin_src emacs-lisp
(defun me/vertico-posframe-reset ()
  "Reset vertico-posframe when it get's offset due to long lines."
  (interactive)
  (posframe-delete-all))
#+end_src

This package also works for selecting files and other similar components.
** center-isearch
source: [[https://www.reddit.com/r/emacs/comments/6ewd0h/comment/dieb3dc/?utm_source=share&utm_medium=web2x&context=3][reddit comment]].

#+begin_src emacs-lisp
(advice-add 'evil-ex-search-next :after
            (lambda (&rest x) (evil-scroll-line-to-center (line-number-at-pos))))
(advice-add 'evil-ex-search-previous :after
            (lambda (&rest x) (evil-scroll-line-to-center (line-number-at-pos))))
#+end_src
** centered-cursor-mode
source: https://github.com/andre-r/centered-cursor-mode.el

#+begin_src emacs-lisp :tangle packages.el
(package! centered-cursor-mode)
#+end_src

#+begin_src emacs-lisp
(use-package centered-cursor-mode
  :defer t
  :config
  ;; Optional, enables centered-cursor-mode in all buffers.
  ;;(global-centered-cursor-mode)
)
#+end_src

Note: ~global-centered-cursor-mode~ causes line jumps while typing on vterm. Disabling for the moment.

#+begin_src emacs-lisp
(add-hook 'prog-mode-hook 'centered-cursor-mode)
(add-hook 'org-mode-hook 'centered-cursor-mode)
#+end_src

Examples: https://emacsredux.com/blog/2020/11/21/disable-global-hl-line-mode-for-specific-modes/

** resize-window
Easier window management with resize-window package. Currently I'm using some quite obnoxious keybindings for window resizing (I use windows a lot):
~M-`~, ~M-~~, ~M->~, ~M-<~ etc.

Resize-window package actually supports a transient.el-like flow (it's older than transient.el though) where after invoking the command ~M-x resize-window~ you can add a series of commands and apply them: make vertial window larger, create new split etc.

#+begin_src emacs-lisp :tangle packages.el
(package! resize-window)
#+end_src

There are only a few commands to learn, and they mimic the normal motions in emacs.

#+begin_src emacs-lisp
(map! :leader "w z" :desc "Activate interactive window resize" #'resize-window)
#+end_src

Package repository [[https://github.com/dpsutton/resize-window][here]].

Also available: [[kbd:][SPC w <]] and [[kbd:][SPC w >]] to increase and decrease width.

Resize main/secondary window into an ideal aspect ratio (60/40):

#+begin_src emacs-lisp
(defun me/window-resize-main-pane ()
  (interactive)
  (setq me/main-window (frame-first-window))
  (window-resize me/main-window (- (truncate (* 0.6 (frame-width))) (window-width me/main-window)) t))

(map! :leader "w ]" #'me/window-resize-main-pane)
(map! "M-z" #'+evil/window-move-left)
(map! "M-Z" #'me/toggle-window-maximize)
#+end_src

=TODO=: Doesn't work with Treemacs enabled.

Source: https://stackoverflow.com/a/7623081

** Toggle maximize
#+begin_src emacs-lisp :tangle yes
(defun me/toggle-window-maximize ()
  (interactive)
  (require 'treemacs)
  ;; forcibly close treemacs (if open)
  (pcase (treemacs-current-visibility)
    (`visible (delete-window (treemacs-get-local-window)))
    (_ (message "")))

  (if (= 1 (length (window-list)))
      ;; winner-undo undoes the last change you made to the state of your widnows.
      ;; This isn't an exact inverse of "delete-other-windows", but it works OK for me in practice.
      (winner-undo)
      (delete-other-windows)))
#+end_src

** highlight-indent-guides
On a fresh Emacs 28.1 install I started to see the highlight indent guides changing colour when a new frame is open (!). The following seems to correct the issue:

#+begin_src emacs-lisp
(after! highlight-indent-guides
  (highlight-indent-guides-auto-set-faces))
#+end_src

Source: [[https://github.com/doomemacs/doomemacs/issues/2666#issuecomment-596700175][github]]
** prompt-for-buffer
Use =SPC w V= (vertical split + follow) or =SPC w S= (horizontal split + follow).

Split to the right and below! Source: [[https://tecosaur.github.io/emacs-config/config.html#windows][here]].

#+begin_src emacs-lisp
(setq split-width-threshold 1)
(setq evil-vsplit-window-right t
      evil-split-window-below t)
#+end_src

Switch to default doom's dashboard on new vsplit/split:

#+begin_src emacs-lisp
(defadvice! prompt-for-buffer (&rest _)
  :after 'evil-window-split (switch-to-buffer (get-buffer "*doom*")))
(defadvice! prompt-for-vbuffer (&rest _)
  :after 'evil-window-vsplit (switch-to-buffer (get-buffer "*doom*")))
#+end_src

Use =M-n= to create a new empty buffer. The following advices will automatically move the buffer window to the right and invoke =consult-projectile=.

** consult
I'm using ~consult~ + ~consult-projectile~ to jump around buffers, recent files and project files. Package repository: [[https://github.com/minad/consult][consult]], [[https://gitlab.com/OlMon/consult-projectile][consult-projectile]]. =consult-projectile= is a consult source to integrate with projectile.

#+begin_src emacs-lisp :tangle packages.el
(package! consult-projectile)
#+end_src

Usually I'm using ~lsp~ with PHP, which seems to be quite slow at times and I'm also using ~vertico-posframe~ so buffer previews are actually not to useful for me:

#+begin_src emacs-lisp
(setq consult-preview-key nil)
#+end_src

Add ~consult--source-bookmark~ to ~consult-projectile~. Bookmarks are global but I usually do [[kbd:][M-p]] to find anything.

#+begin_src emacs-lisp
(setq consult-projectile-sources
  '(consult-projectile--source-projectile-buffer   ;; buffers in projectile
    consult-projectile--source-projectile-recentf  ;; recent files in projectile
    consult-projectile--source-projectile-file     ;; projectile files
    consult--source-project-recent-file            ;; project's recent files
    consult--source-bookmark                       ;; bookmarks
    consult-projectile--source-projectile-project));; projectile projects
#+end_src

By default ~projectile-buffer~ source order's items in MRU (putting current opened entries last, mind). Other sources do not do MRU.

** TODO Display time
#+begin_src emacs-lisp
(setq
 display-time-format "w%U"
 display-time-default-load-average nil
 doom-modeline-time-icon nil)
(display-time)
#+end_src
** TODO Doom modeline
#+begin_src emacs-lisp
(setq doom-modeline-buffer-file-name-style 'file-name)
#+end_src
* Keybindings
** Navigation and files
*** General
- Shortcut for opening the Doom's dashboard
#+begin_src emacs-lisp
(map! :leader :desc "Open Dashboard" "d" #'+doom-dashboard/open)
#+end_src

- Setting up this keybinding for the "command palette". I'm still unsure which keybinding is the most commonly used for me.
#+begin_src emacs-lisp
(map! "M-;" 'execute-extended-command)
(map! "M-<return>" 'execute-extended-command)
#+end_src

- Toggle treemacs with M-t (tree)
#+begin_src emacs-lisp
(map! "M-t" #'+treemacs/toggle)
(map! "M-u" #'ranger)
#+end_src

- Save buffer:
Quickly save buffer with ~M-s~ (save).

#+begin_src emacs-lisp
(map! "M-s" #'save-buffer)
#+end_src

- ielm

#+begin_src emacs-lisp
(map! :leader ";" 'ielm)
(map! "M-:" 'ielm)
#+end_src

*** Search
- Search buffer:
#+begin_src emacs-lisp
(map! "M-f" #'+default/search-buffer)
(map! "M-F" (lambda() (interactive) (me/vertico-repeat-last-command #'+default/search-buffer)))
#+end_src

- Search project:
Search project's contents with ~M-F~.

#+begin_src emacs-lisp
;(map! "M-r" #'+default/search-project)
(map! "M-C-f" (lambda() (interactive) (me/vertico-repeat-last-command #'+default/search-project)))
#+end_src

Also use ~SPC s s~ to search matching characters on the current buffer.

- Go to item:
Use =M-m= for jump into a menu item (section in the buffer).

#+begin_src emacs-lisp
(map! "M-m" #'consult-imenu)
(defadvice! expand-folds-imenu(&rest _)
  :before 'consult-imenu (+org/open-all-folds))
(defadvice! expand-folds-imenu(&rest _)
  :before '+default/search-buffer (+org/open-all-folds))
#+end_src

- Find project files
~M-p~: find file in project, also ~SPC SPC~. Prefer consult for everything.

#+begin_src emacs-lisp
(map! "M-p" #'consult-projectile)
(map! "M-P" (lambda() (interactive) (me/vertico-repeat-last-command #'consult-projectile)))
(map! "M-C-p" (lambda() (interactive) (me/vertico-repeat-last-command #'projectile-find-file)))

(map! :leader "SPC" 'consult-bookmark)
#+end_src

- Find buffers
#+begin_src emacs-lisp
(map! "M-b" #'consult-project-buffer)
(map! "M-B" (lambda() (interactive) (me/vertico-repeat-last-command #'consult-project-buffer)))
(map! "M-C-b" (lambda() (interactive) (me/vertico-repeat-last-command #'consult-buffer)))
#+end_src

- Search in buffer
#+begin_src emacs-lisp :tangle packages.el
(package! evil-snipe :disable t)
#+end_src

#+begin_src emacs-lisp
(remove-hook 'doom-first-input-hook #'evil-snipe-mode)
(with-eval-after-load 'evil-maps
  (define-key evil-normal-state-map (kbd "s") 'evil-ex-search-forward)
  (define-key evil-normal-state-map (kbd "S") 'evil-ex-search-backward))
#+end_src
*** Windows
- Next/previous window
#+begin_src emacs-lisp
(map! "M-]" #'next-window-any-frame)
(map! "M-[" #'previous-window-any-frame)
#+end_src

- Delete window
Use =M-w= to delete window or workspace (last window is preserved).
#+begin_src emacs-lisp
(map! "M-w" 'delete-window)
#+end_src

- Terminal pop up
#+begin_src emacs-lisp
(map! "M-y" '+vterm/toggle)
#+end_src

*** Navigation
- Go to definition other window
Use =M-g= to find reference in other window.

#+begin_src emacs-lisp
(map! "M-g" #'xref-find-definitions)
(map! "M-G" #'xref-find-definitions-other-window)
#+end_src

=g d= changes my context when I just want to peek at the definition of a method. So quickly jumping in other-window work just fine for me.

- Page up / down
#+begin_src emacs-lisp
(map! "M-k" 'evil-scroll-up)
(map! "M-j" 'evil-scroll-down)

(after! evil-org
  (define-key evil-org-mode-map (kbd "<normal-state> M-k") 'evil-scroll-up)
  (define-key evil-org-mode-map (kbd "<normal-state> M-j") 'evil-scroll-down))
#+end_src
The ~after!~  block makes sure =M-j= and =M-k= are binded correctly on org mode.

- Go to last change
#+begin_src emacs-lisp
(with-eval-after-load 'evil-maps
  (define-key evil-normal-state-map (kbd "M-,") 'goto-last-change-reverse)
  (define-key evil-normal-state-map (kbd "M-.") 'goto-last-change))
#+end_src

- Go to line

#+begin_src emacs-lisp
(map! "M-l" 'consult-goto-line)
#+end_src


** TODO Buffers and Edition
- Evaluate line or region

#+begin_src emacs-lisp
(map! :ne "M-e" #'+eval/line-or-region)
#+end_src

- New empty buffer
#+begin_src emacs-lisp
(map! :ne "M-n" #'evil-buffer-new)
#+end_src

- Comment or uncomment region
#+begin_src emacs-lisp
(map! :ne "C-/" #'comment-or-uncomment-region)
#+end_src
TODO: Most code-related keybindings should be =C-<something>=.

- Copy and paste
Support yanking/killing via M-v, M-c
#+begin_src emacs-lisp
(map! (:when IS-MAC (:map general-override-mode-map :gi :desc "Paste from clipboard" "M-v" 'yank)))
(map! :desc "Copy into clipboard" "M-c" 'copy-region-as-kill)
#+end_src
Source: https://github.com/doomemacs/doomemacs/issues/906#issuecomment-455279422

- Mark paragraph
Visually selects the paragraph. Execute multiple times to expand the selection or move the cursor.

#+begin_src emacs-lisp
(map! :leader :desc "Visually mark paragraph" "v p" 'er/mark-paragraph)
(map! :leader :desc "Visually mark word" "v w" 'er/mark-word)
#+end_src

Use ~SPC v p~ to *v*isual select a *p*aragraph and ~SPC v w~ to select a word under cursor.

Worth checking out [[https://www.johndcook.com/blog/2017/08/09/selecting-things-in-emacs/][this]] article.

Triggers consult posframe to select a yasnippet. It also previsualies it in the buffer:

#+begin_src emacs-lisp
(map! "M-i" #'consult-yasnippet)
#+end_src

There's also =SPC i s= keybinding which doesn't uses consult.

- Create link
#+begin_src emacs-lisp
(after! evil-org
  (define-key evil-org-mode-map (kbd "<visual-state> M-l") 'org-insert-link))
#+end_src

- Edit source block
Edit source block in capture buffer.
#+begin_src emacs-lisp
(global-set-key (kbd "C-c e") 'org-edit-src-code)
#+end_src
TODO: Consider using =M-e= to =org-edit-src-code=, =C-c e= for elfeed. Although I don't use edit-src-code a lot.

- Move-text
#+begin_src emacs-lisp :tangle packages.el
(package! move-text)
#+end_src

#+begin_src emacs-lisp
(use-package move-text
  :config
)
#+end_src

#+begin_src emacs-lisp
(map! "M-K" 'move-text-up)
(map! "M-J" 'move-text-down)
#+end_src

Note: Use =M-J=, =M-L= in org mode. In other modes just =M-j=, =M-k=.

* Writing
** Spell checking
Change dictionary with the following:

#+begin_src emacs-lisp
(use-package ispell
  :defer t)
(use-package flyspell
  :defer t)
#+end_src

#+begin_example
ispell-change-dictionary
#+end_example

Or use the following configuration:

#+begin_src emacs-lisp
(setq ispell-dictionary "british")
(setq company-ispell-available nil)
#+end_src

Use ~z-=~ to get spelling corrections while under a word.

Doom Emacs also come with these 2 packages for grammar checking:

- [[https://github.com/mhayashi1120/Emacs-langtool][Langtool]]
- [[https://github.com/bnbeckwith/writegood-mode][Writegood-mode]]

*** Langtool
For langtool package you need to install the underlying tool languagetool, which is a java package. See instructions [[https://docs.doomemacs.org/latest/#/prerequisites][here]].

Configure language:

#+begin_src emacs-lisp
(setq langtool-default-language "en-GB")
#+end_src

#+begin_src emacs-lisp
(defun langtool-autoshow-detail-popup (overlays)
  (when (require 'popup nil t)
    ;; Do not interrupt current popup
    (unless (or popup-instances
                ;; suppress popup after type `C-g` .
                (memq last-command '(keyboard-quit)))
      (let ((msg (langtool-details-error-message overlays)))
        (popup-tip msg)))))

(setq langtool-autoshow-message-function
      'langtool-autoshow-detail-popup)
#+end_src

*** Writegood
Check the [[https://matt.might.net/articles/shell-scripts-for-passive-voice-weasel-words-duplicates/][original article]] for writegood.
* Coding

#+begin_src emacs-lisp
(add-hook 'prog-mode-hook 'display-fill-column-indicator-mode)
#+end_src

** smart-parens
#+begin_src emacs-lisp
(after! smartparens
  (smartparens-global-mode -1))
#+end_src
Source: https://github.com/doomemacs/doomemacs/blob/develop/docs/faq.org#how-to-disable-smartparensautomatic-parentheses-completion

** expand-region
Visually select text regions with ~M-=~:
#+begin_src emacs-lisp :tangle packages.el
(package! expand-region)
#+end_src
See repository [[https://github.com/magnars/expand-region.el][here]].

#+begin_src emacs-lisp
(use-package expand-region
  :bind ("M-=" . er/expand-region))
#+end_src

See mention [[https://takeonrules.com/2020/10/18/why-i-chose-emacs-as-my-new-text-editor/][here]].
** syntax-entry
#+begin_src emacs-lisp
(modify-syntax-entry ?# "< b")
(modify-syntax-entry ?\n "> b")
(modify-syntax-entry ?$ "w")
(modify-syntax-entry ?_ "w")
(modify-syntax-entry ?- "w")
(modify-syntax-entry ?+ "w")

(add-hook 'php-mode-hook '(lambda ( )
    ;(modify-syntax-entry ?> "." php-mode-syntax-table)
    ;(modify-syntax-entry ?- "." php-mode-syntax-table)
    ;(modify-syntax-entry ?_ "w" php-mode-syntax-table)
    (modify-syntax-entry ?$ "w" php-mode-syntax-table)
))
#+end_src
** flycheck
Most classes/php files I'm working with are quite large and cause a large number of errors to popup. I'm topping up the error threshold to avoid a warning during start up:

#+begin_src emacs-lisp
(setq flycheck-checker-error-threshold 5000)
#+end_src

Most projects I work with are somewhat following the PSR12 standard, so let's configure flycheck to respect that:
#+begin_src emacs-lisp
(setq flycheck-phpcs-standard "PSR12"
      flycheck-php-phpcs-executable "/usr/local/bin/phpcs")
#+end_src
** lsp
I'm working on a large series of interrelated projects which work well under the same directory structure (code/{project1, project2, project3}).
The downside is that this causes LSP to complain about the large number of files and file descriptors it uses.

So I'm forced to top up the default threshold via this variable:

#+begin_src emacs-lisp
(setq lsp-file-watch-threshold 5000)
#+end_src

#+begin_src emacs-lisp
(with-eval-after-load 'lsp-mode
  (add-to-list 'lsp-file-watch-ignored-directories "[/\\\\]vendor\\'")
  (add-to-list 'lsp-file-watch-ignored-directories "[/\\\\]misc-dev-contrib\\~")
  (add-to-list 'lsp-file-watch-ignored-directories "[/\\\\]misc\\'")
  (add-to-list 'lsp-file-watch-ignored-directories "[/\\\\]push-notifications\\'")
  (add-to-list 'lsp-file-watch-ignored-directories "[/\\\\]main\\'")
  (add-to-list 'lsp-file-watch-ignored-directories "[/\\\\]kantox-sdk-guzzle5\\'")
  (add-to-list 'lsp-file-watch-ignored-directories "[/\\\\]ecadmin\\'")
  (add-to-list 'lsp-file-watch-ignored-directories "[/\\\\]docs-api-swagger\\'")
  (add-to-list 'lsp-file-watch-ignored-directories "[/\\\\]docs-network-api-swagger\\'")
  (add-to-list 'lsp-file-watch-ignored-directories "[/\\\\]dbmigration\\'")
  (add-to-list 'lsp-file-watch-ignored-directories "[/\\\\]admin-v2\\'")
  (add-to-list 'lsp-file-watch-ignored-directories "[/\\\\]static\\'")
  (add-to-list 'lsp-file-watch-ignored-directories "[/\\\\]sandbox\\'")
  (add-to-list 'lsp-file-watch-ignored-directories "[/\\\\]rtb\\'")
  (add-to-list 'lsp-file-watch-ignored-directories "[/\\\\]management\'")
  ;; or
  (add-to-list 'lsp-file-watch-ignored-files "[/\\\\]\\.my-files\\'"))
  #+end_src

 #+begin_src emacs-lisp
(use-package lsp-ui
  :after lsp-mode
  :defer t)

(setq lsp-idle-delay 0.1
    company-minimum-prefix-length 2
    company-idle-delay 0.1
    company-tooltip-minimum-width 50
    company-tooltip-maximum-width 120
    lsp-ui-doc-include-signature t
    lsp-ui-doc-max-width 120
    lsp-ui-doc-max-height 20
    lsp-ui-doc-enable t
    lsp-signature-render-documentation t
    lsp-signature-auto-activate t
    lsp-enable-snippet nil
    lsp-signature-function 'lsp-signature-posframe)

(use-package lsp-treemacs
  :defer t)
 #+end_src

 #+begin_src emacs-lisp
(setq lsp-headerline-breadcrumb-enable t)
(setq lsp-headerline-breadcrumb-segments '(symbols))
(setq lsp-headerline-breadcrumb-icons-enable t)
(setq lsp-headerline-breadcrumb-enable-diagnostics nil)
 #+end_src

 #+begin_src emacs-lisp
(map! "M-C-x" 'lsp-ui-peek-find-references)
(map! "M-M" 'consult-lsp-symbols)
(map! "M-C-f" 'lsp-format-region)
 #+end_src
** rainbow-delimiters-mode
Rainbow colouring for brackets and other delimiters in prog mode. Package: [[https://elpa.nongnu.org/nongnu/rainbow-delimiters.html][nongnu elpa]].

#+begin_src emacs-lisp :tangle packages.el
(package! rainbow-delimiters)
#+end_src

#+begin_src emacs-lisp
(add-hook 'prog-mode-hook #'rainbow-delimiters-mode)
#+end_src
** yasnippets
I'm using [[https://github.com/joaotavora/yasnippet][Yasnippets]] package to manage code snippets. As per the instructions:

#+begin_src emacs-lisp :tangle no
(use-package yasnippet
  :defer t
  :config (yas-global-mode 1))
#+end_src

*Warning*: I had to disable (:tangle no) yas-global-mode since it interfered with LSP/company-mode. Throwing errors trying to display completions on PHP-mode.
With this settings disabled now both company mode and yas-snippets work just fine.

Note: I'm disabling the following due to poor performance:
#+begin_src emacs-lisp :tangle no
(require 'package)
(add-to-list 'package-archives
             '("melpa" . "http://melpa.org/packages/") t)
(package-initialize)
#+end_src

Additionally I'm installing pre-defined snippets with the package [[The above instructions also setup the package][Yasnippets-snippets]]:
#+begin_src emacs-lisp
(use-package yasnippet-snippets
  :defer t)
#+end_src

As per the [[package-refresh-contents][instructions]] I'm configuring melpa archive repositories. After that the command ~package-refresh-contents~ must be ran to be able to pull updates from it:

- ~M-x package-refresh-contents~
- ~M-x package-install yasnippet-snippets~

In the code above I'm actually requiring the package via lisp, which should install and load it.

There's an additional package with extra snippets maintained by the Doom Emacs' github organization: [[https://github.com/doomemacs/snippets][doomemacs/snippets]]
I'm also imported several snippets from [[https://github.com/cartolari/yasnippet-vim-snippets][cartolari/yasnippet-vim-snippets]] repository, primarily [[https://github.com/cartolari/yasnippet-vim-snippets/tree/master/snippets/php-mode][php-mode]].

Tip: Use ~M-x yas-describe-tables~ to see the list of snippets and edit them.

Consult integration with yasnippet:
#+begin_src emacs-lisp :tangle packages.el
(package! consult-yasnippet)
#+end_src

Tip: Use =consult-yasnippet=.
** devdocs
This package somewhat expands on Doom Emacs' [[https://docs.doomemacs.org/latest/modules/tools/lookup/][lookup]] functionality.

#+begin_src emacs-lisp :tangle packages.el
(package! devdocs)
#+end_src

The ~SPC s o~ opens up documentation for the current symbol under cursor in the default browser. I didn't like to require a browser to navigate documentation as I don't want to leave the code I'm working on to check on something.

Alternatively it can be configured to use ~eww~ instead. Which is way better. But the problem is devdocs require javascript to work correctly (it can work offline, but still requires a browser and javascript enabled).

This package uses devdocs generated documentation (downloads it) and queries it offline, showing it on a separate window/buffer.

#+begin_src emacs-lisp
(use-package devdocs
  :defer t)

(global-set-key (kbd "C-h D") 'devdocs-lookup)
#+end_src

Use ~C-h D~ or ~SPC h D~ to search for the symbol under cursor. Note: The documentation will not be displayed right away, you'll need to press RET on the given symbol.
** better-jumper
Better jump (remember jump list).

#+begin_src emacs-lisp :tangle packages.el
(package! better-jumper)
#+end_src

#+begin_src emacs-lisp
(use-package better-jumper
  :defer t
  :config
  (better-jumper-mode +1))
(with-eval-after-load 'evil-maps
  (define-key evil-motion-state-map (kbd "C-o") 'better-jumper-jump-backward)
  (define-key evil-motion-state-map (kbd "C-i") 'better-jumper-jump-forward))
#+end_src

Use with C-o to jump out of the last item and C-i to jump in to the next item in the list.
** avy
#+begin_src emacs-lisp
(with-eval-after-load 'evil-maps
    (define-key evil-normal-state-map "f" 'avy-goto-char-timer))
(setq avy-timeout-seconds 1
      avy-single-candidate-jump t)
#+end_src
** multiple-cursors
Doom Emacs supports 2 multi-cursor packages out of the box: doom-package:evil-mc and doom-package:evil-multiedit. These packages can be enabled via doom-module:multiple-cursors module.

The packages approach to multiple cursors is different. [[doom-package:evil-mc]] work similar to other multiple-cursor implementations, that's it: you enable cursors in multiple places. On the other hand [[doom-package:evil-multiedit]] works by regions: you visually select selections and work on them.

By default [[kbd:][M-d]]  and [[kbd:][M-S-d]] creates [[doom-package:evil-multiedit]] sections. Use ~R~ in visual mode to create selections across the whole buffer. Use ~:iedit/REGEX~ to create sections via ex command.

- [[kbd:][M-d]] to iedit the symbol at point. Again to iedit its next match.
- [[kbd:][M-S-d]] to do it backwards.
- [[kbd:][R]] (in visual mode) to iedit all matches of the selection at point in the  buffer.
- Or ~:iedit/REGEX~ to iedit all matches of REGEX.

[[doom-package:evil-mc]] is bounded to [[kbd:][gz ]]prefix keys and has several keybindings.
- [[kbd:][gzz]] to toggle new (frozen) cursors at point.
- [[kbd:][gzt]] to toggle mirroring on and off (or switch to insert mode to activate them).
- [[kbd:][gzA]] to place cursors at the end of each selected line.
- [[kbd:][gzI]] will place them at the beginning.
- There's also the ex command ~:mc/REGEXP/FLAGS~, for laying down cursors by  regex.

I don't like these keybindings so I create these down below to work with [[doom-package:evil-mc]]:

- [[kbd:][C-d]] create cursor and go to next match.
- [[kbd:][C-j]] create cursor and move next line.
- [[kbd:][C-k]] create cursor and move previous line.

#+begin_src emacs-lisp
(global-evil-mc-mode  1)

(with-eval-after-load 'evil-maps
  (global-set-key (kbd "C-d") 'evil-mc-make-and-goto-next-match)
  (define-key evil-normal-state-map (kbd "C-j") 'evil-mc-make-cursor-move-next-line)
  (define-key evil-normal-state-map (kbd "C-k") 'evil-mc-make-cursor-move-prev-line)

  (define-key evil-visual-state-map (kbd "C-d") 'evil-mc-make-and-goto-next-match)
  (define-key evil-normal-state-map (kbd "C-d") 'evil-mc-make-and-goto-next-match))
#+end_src

[[doom-package:evil-multiedit]] seems to be case-insensitive by default, this snippet forces it to be case-sensitive in matches:
#+begin_src emacs-lisp
(defun me/make-evil-multiedit-case-sensitive (fn &rest args)
  (let ((case-fold-search (not iedit-case-sensitive)))
    (apply fn args)))

(advice-add #'evil-multiedit-match-and-next :around #'me/make-evil-multiedit-case-sensitive)
#+end_src
Source: https://github.com/hlissner/evil-multiedit/issues/48#issuecomment-1011418580

* Version control
Often times it's useful to see the local file in the browser, for example to share the exact code you're looking into:
#+begin_src emacs-lisp :tangle packages.el
(package! browse-at-remote)
#+end_src

** Git
Configure user and email address:
#+begin_src bash :tangle no
git config --local user.email "des@riseup.net"
git config --local user.name "DC*"
#+end_src

This configuration applies to the repository the command is running on (--local). You can apply global (i.e. to all repositories) replacing --local with the flag --global.

#+begin_src emacs-lisp
(map! "M->" 'git-gutter:next-hunk)
(map! "M-<" 'git-gutter:previous-hunk)
#+end_src

** Magit
[[https://magit.vc/][Magit]] is a deal-breaker type of package for Emacs. It forever changes the way you interact with Git (Goodbye cli!).

#+begin_src emacs-lisp
(after! magit
    (setq git-commit-summary-max-length 100))
#+end_src

Anyway, in the above code setting the commit's summary max length to 100 so I'm not bothered with auto-formattig in commit's title/descriptions.

#+begin_src emacs-lisp
(defun me/magit-commit-setup ()
  (insert (concat (magit-get-current-branch) ": ")))

(add-hook 'git-commit-setup-hook 'me/magit-commit-setup)

#+end_src

* Project management
** projectile
#+begin_src emacs-lisp
(after! projectile
   (setq projectile-project-search-path '("~/sys-vagrant/code")))
#+end_src
** treemacs
Enable treemacs and never move to treemacs with other-window as well as disabling wrap around:

#+begin_src emacs-lisp
(use-package treemacs
  :defer t
  :config
  (setq treemacs-is-never-other-window t
        treemacs-wrap-around nil
        treemacs-display-current-project-exclusively t
        treemacs-follow-mode t))
#+end_src

Take a look at more configuration options in [[https://github.com/Alexander-Miller/treemacs#configuration][github]].

Ensure treemacs-projectile integration:

#+begin_src emacs-lisp :tangle packages.el
(package! treemacs-projectile)
#+end_src

#+begin_src emacs-lisp
(use-package treemacs-projectile
  :after (treemacs projectile))
#+end_src

Ensure treemacs-magit integration:

#+begin_src emacs-lisp
(use-package treemacs-magit
  :defer t
  :after (treemacs magit))

#+end_src

Ensure treemacs-persp integration:

#+begin_src emacs-lisp
(use-package treemacs-persp ;;treemacs-perspective if you use perspective.el vs. persp-mode
  :after (treemacs persp-mode) ;;or perspective vs. persp-mode
  :config (treemacs-set-scope-type 'Perspectives))
#+end_src
** TODO workspaces
#+begin_src emacs-lisp :tangle no
(defun me/switch-workspace-in-new-frame ()
  (interactive)
  (select-frame (make-frame))
  (toggle-frame-maximized)
  (call-interactively #'+workspace/load))
(map! "M-±" #'me/switch-workspace-in-new-frame)
#+end_src

Overwrite default =SPC TAB TAB= with a consult base selection:

#+begin_src emacs-lisp
(defun me/switch-workspace ()
  (interactive)
  (call-interactively #'+workspace/switch-to))

(map! "M-§" 'me/switch-workspace)
#+end_src

Switch to next workspace with ~SPC TAB TAB~:

#+begin_src emacs-lisp
(map! :leader
    :desc "Switch workspace"
    "TAB TAB" #'+workspace:switch-next)
#+end_src

Quickly switch to workspace 1, 2, 3, 4 with ~SPC 1, 2, 3, 4~:
#+begin_src emacs-lisp
(map! :leader
    :desc "Switch workspace 0"
    "1" #'+workspace/switch-to-0)
(map! :leader
    :desc "Switch workspace 1"
    "2" #'+workspace/switch-to-1)
(map! :leader
    :desc "Switch workspace 2"
    "3" #'+workspace/switch-to-2)
(map! :leader
    :desc "Switch workspace 3"
    "4" #'+workspace/switch-to-3)
(map! :leader
    :desc "Switch workspace 5"
    "5" #'+workspace/switch-to-4)
#+end_src
** TODO ranger
#+begin_src emacs-lisp :tangle packages.el
(package! ranger)
#+end_src

Here's some custom configuration options, take a look at the [[https://github.com/punassuming/ranger.el#configuration][configuration section]] in the package documentation for more options.
#+begin_src emacs-lisp
(setq ranger-preview-delay 0 ;; delay preview (seconds)
      ranger-show-literal t  ;; do not highlight preview (prevents lsp from running)
      ranger-parent-depth 3) ;; number of parent directories windows
#+end_src

* Org everything
** org-mode
If you use ~org~ and don't want your org files in the default location below, change ~org-directory~. It must be set before org loads!

#+begin_src emacs-lisp
(setq org-directory "~/org/")
(after! org
  (setq
    org-startup-folded nil
    org-hide-emphasis-markers t))

(defun me/org-disable-line-numbers-mode()
  (display-line-numbers-mode -1))

; File mode specification error: (void-function me/org-disable-hl-indent-mode)
(defun me/org-disable-indent-mode()
  (setq org-indent-mode -1))

;(defun me/org-disable-git-gutter-mode()
;  (git-gutter-mode -1))

(defun me/org-enable-literate-calc-minor-mode()
  (literate-calc-minor-mode 1))

;(defun me/org-disable-hl-indent-guides()
;  (highlight-indent-guides-mode -1))

(add-hook 'org-mode-hook 'visual-line-mode)
(add-hook 'org-mode-hook 'variable-pitch-mode)
(add-hook 'org-mode-hook 'me/org-disable-indent-mode)
(add-hook 'org-mode-hook 'me/org-disable-line-numbers-mode)
;(add-hook 'org-mode-hook 'me/org-disable-hl-indent-guides)

; Disabling as it causes errors when buffers as killed before the result is computed,
; usually while switching quickly between org files
;(add-hook 'org-mode-hook 'me/org-enable-literate-calc-minor-mode)

;; see https://github.com/doomemacs/doomemacs/issues/4815#issue-834176237
;(add-to-list 'git-gutter:disabled-modes 'org-mode)
#+end_src

Disable company-mode (autocompletions) on org-mode (i.e. prose):
#+begin_src emacs-lisp
(setq company-global-modes '(not org-mode))
#+end_src

#+begin_src emacs-lisp
(setq org-archive-location (concat "archive/archive-"
                                   (format-time-string "%Y%m" (current-time)) ".org_archive::"))
#+end_src

Do not create bookmarks on last org-capture:
#+begin_src emacs-lisp
(setq org-capture-bookmark nil)
#+end_src
** TODO org-capture
#+begin_src emacs-lisp
(setq org-capture-templates
    '(("t" "TODO" entry (file+headline +org-capture-todo-file "Inbox")
       "* TODO %? %U\n%i\n%a" :prepend t)
      ("n" "Notes" entry (file+headline +org-capture-notes-file "Inbox")
       "* %u %?\n%i\n%a" :prepend t)
      ("j" "Journal" entry (file+olp+datetree +org-capture-journal-file)
       "* %U %?\n%i\n%a" :prepend t)))
#+end_src

Keybinding to specific org-capture:
#+begin_src emacs-lisp
(defun me/org-capture-todo (type &optional arg)
  (interactive "P")
  (org-capture arg type))

(map! :leader :desc "Capture a TODO item" "c t" (lambda() (interactive) (me/org-capture-todo "t")))
(map! :leader :desc "Capture a new note" "c n" (lambda() (interactive) (me/org-capture-todo "n")))
(map! :leader :desc "Capture a new journal entry" "c j" (lambda() (interactive) (me/org-capture-todo "j")))
#+end_src

** TODO org-agenda
#+begin_src emacs-lisp
(map! "M-o" 'org-agenda)
#+end_src
Custom agenda commands! \o/

#+begin_src emacs-lisp
(setq org-agenda-custom-commands
      '(
        ("w" "List :work: TODO/WAITING|INPROGRESS|NEXT"
          ((tags "work/TODO|WAITING|INPROGRESS|NEXT")))
        ("d" "List :docs: TODO/WAITING|INPROGRESS|NEXT"
          ((tags "docs/TODO|WAITING|INPROGRESS|NEXT")))
        ("p" "List :personal: TODO/INPROGRESS/NEXT"
            ((tags "personal/TODO|INPROGRESS|NEXT")))
        ("P" "List :projects: TODO/INPROGRESS/NEXT"
            ((tags "projects/TODO|INPROGRESS|NEXT")))
        ("e" "List :emacs: TODO/INPROGRESS/NEXT"
            ((tags "emacs/TODO|INPROGRESS|NEXT")))
        ("l" "List :learning:"
            ((tags "learning")))
    ))
#+end_src

Source: [[https://stackoverflow.com/a/34660219][stackoverflow]].

Sorting strategy:

#+begin_src emacs-lisp
(setq org-agenda-sorting-strategy '((agenda priority-down todo-state-down)
                                    (todo priority-down todo-state-down)
                                    (tags priority-down todo-state-down)
                                    (search priority-down todo-state-down category-keep)))
#+end_src

See documentation [[https://orgmode.org/org.html#Sorting-of-agenda-items][here]].

Keybinding to specific org-agenda views:
#+begin_src emacs-lisp
(defun me/org-agenda-view (type &optional arg)
  (interactive "P")
  (split-window-horizontally)
  (other-window 1)
  (org-agenda arg type))

(map! :leader :desc "Work view" "o a w" (lambda() (interactive) (me/org-agenda-view "w")))
(map! :leader :desc "Docs view" "o a d" (lambda() (interactive) (me/org-agenda-view "d")))
(map! :leader :desc "Personal view" "o a p" (lambda() (interactive) (me/org-agenda-view "p")))
(map! :leader :desc "Projects view" "o a P" (lambda() (interactive) (me/org-agenda-view "P")))
(map! :leader :desc "Emacs view" "o a e" (lambda() (interactive) (me/org-agenda-view "e")))
(map! :leader :desc "Learning view" "o a l" (lambda() (interactive) (me/org-agenda-view "l")))
#+end_src
Source: [[https://emacs.stackexchange.com/a/868][Stackoverflow]].

Remove file names on agenda views:
#+begin_src emacs-lisp
(setq org-agenda-prefix-format "%t %s")
#+end_src
Source: [[https://lists.gnu.org/archive/html/emacs-orgmode/2010-01/msg00743.html][here]].
** TODO org-modern
It's overkill but I'm using =org-modern= to prettify symbols such as +title and +begin_src. I'm actually happy with =org-bullets=.

#+begin_src emacs-lisp :tangle packages.el
(package! org-modern)
#+end_src

#+begin_src emacs-lisp
(use-package org-modern
  :config
  (setq org-modern-star nil)
  (setq org-modern-timestamp nil)
  (setq org-modern-todo nil)
  (setq org-modern-tag nil)
  (setq org-modern-statistics nil)
  (setq org-modern-table nil)
  (setq org-modern-hide-stars nil)
  (custom-set-faces
   '(org-modern-block-name ((t nil))))
  (global-org-modern-mode))
#+end_src
** TODO org-babel
Using =org-babel-tangle= each time you make an edition to an org file gets old very quickly. With =org-auto-tangle= you can define an auto-tangling option for the org file you're working with, so each time you save the buffer =org-babel= kicks in.

#+begin_src emacs-lisp :tangle packages.el
(package! org-auto-tangle)
#+end_src

We don't usually tangle every org-file we work with, so I'm setting =org-auto-tangle-default= to =nil= to disable this functionality. Use =:auto_tangle yes= to automatically tangle the org file you're editing:

#+begin_src emacs-lisp
(use-package org-auto-tangle
  :defer t
  :hook (org-mode . org-auto-tangle-mode)
  :config
  (setq org-auto-tangle-default nil))
#+end_src

I'm working with =org-babel= primarly in ruby. While =org-babel= works pretty well out of the box in order to support =:session= we need this package:
#+begin_src emacs-lisp :tangle packages.el
(package! inf-ruby)
#+end_src

=:session= help us to evaluate code blocks as a whole. Meaning that different code blocks can interact as a whole unit.

For example: I can create a funcion in a given code block as follows:
#+begin_src ruby :tangle no :session example
def hello_world
  "Hello world!"
end
#+end_src

In a different code block I can call this function:
#+begin_src ruby :tangle no :resuts output :session example
hello_world
#+end_src

All code blocks are ran synchronously. This means the Emacs UI is blocked until the process is done. Unless you use this package:

#+begin_src emacs-lisp :tangle packages.el
(package! ob-async)
#+end_src

Add =:async= to the source block and the process should run asynchronously. Repository [[https://github.com/astahlman/ob-async][here]].

org-babel support for PlantUML:
#+begin_src emacs-lisp
(setq plantuml-jar-path "/usr/local/bin/plantuml.jar")
(setq plantuml-default-exec-mode 'jar)

#+end_src

#+begin_src emacs-lisp :tangle packages.el
(package! ob-http)
#+end_src

#+begin_src emacs-lisp
(use-package! ob-http
  :commands org-babel-execute:http)

#+end_src

This is required to have ob-http be properly loaded in Doom Emacs. See response [[https://discord.com/channels/406534637242810369/1027578581032915045/1027589113257414708][here]].
#+begin_src emacs-lisp
(after! org
  (add-to-list 'org-src-lang-modes '("http" . ob-http))
  (autoload 'ob-http-mode "ob-http-mode" nil t))
#+end_src

Alternatively you can use:
#+begin_example emacs-lisp
(use-package! ob-http
  :commands (ob-http-mode org-babel-execute:http))

(after! org
  (add-to-list 'org-src-lang-modes '("http" . ob-http)))
#+end_example

** org-roam
Org-roam is a package to create a non-hierarchical knowledge base. The package is meant to be used as a Zettelkasten note taking tool.

#+begin_src emacs-lisp
(use-package org-roam
  :defer t
  :custom
  (org-roam-directory "~/org/roam")
  (org-roam-index-file "~/org/roam/index.org")
  )
#+end_src

We're making only a few configurations only since Doom Emacs already integrates the package via ~:editor (org +roam)~.

#+begin_src emacs-lisp
(defun me/counsel-ag-roam ()
 "Do counsel-ag on the org roam directory"
 (interactive)
 (counsel-ag nil org-roam-directory))
#+end_src

Search org-roam notes via consult (source: [[https://github.com/jgru/consult-org-roam#installation][here]]):

#+begin_src emacs-lisp :tangle packages.el
(package! consult-org-roam)

#+end_src
#+begin_src emacs-lisp
(use-package consult-org-roam
  :defer t
   :init
   (require 'consult-org-roam)
   ;; Activate the minor-mode
   (consult-org-roam-mode 1)
   :custom
   (consult-org-roam-grep-func #'consult-ripgrep)
   :config
   ;; Eventually suppress previewing for certain functions
   (consult-customize
    consult-org-roam-forward-links
    :preview-key (kbd "M-.")))

(map! :leader
      :desc "Search via consult"
      "n r S" #'consult-org-roam-search)
#+end_src

Keybinding example (see this [[https://rameezkhan.me/adding-keybindings-to-doom-emacs/][blog]]).
** org-todo-keywords
Custom ~org-todo-keywords~. It needs to be wrapper in (~after! ..~) block to apply correctly (see [[https://github.com/doomemacs/doomemacs/issues/2913#issuecomment-614773557][comment]]).

#+begin_src emacs-lisp
(after! org
    (setq org-todo-keywords
        '((sequence  "REPEAT(r)" "PROJ(p)" "TODO(t)" "NEXT(n)" "WAITING(w)" "INPROGRESS(i)" "|" "DONE(d)" "CANCELED(c)")))
    (setq org-tag-alist '(("personal" . ?p) ("projects" . ?P) ("learning" . ?l) ("@home" . ?h) ("work" . ?w) ("@computer" . ?c) ("errands" . ?e)))
    )
#+end_src

I'm also configuring a few tags to classify items under.
** org-bullets
This package is a lightweight alternative to [[https://github.com/minad/org-modern][org-modern]]. Project page [[https://github.com/sabof/org-bullets][here]].

I opted for this package rather than org-modern since the latter was rather invasive changing for example the look of dates, tags etc.

#+begin_src emacs-lisp :tangle packages.el
(package! org-bullets)
#+end_src

#+begin_src emacs-lisp
(use-package org-bullets
  :defer t
  :config
    (add-hook 'org-mode-hook (lambda () (org-bullets-mode 1)))
  )
#+end_src

In the above block I'm enabling the org-bullets-mode after ~org-mode~ is enabled (see documentation [[https://orgmode.org/worg/doc.html][here]].)
** org-log-repeat
Disable log lines on repeat tasks.

#+begin_src emacs-lisp
(use-package org
  :config
    (setq org-log-repeat nil)
)
#+end_src

This code disables logging status changes on TODO and agenda entries.
** toc-org
This package automatically generates and maintains a Table of Contents for Org and Markdown files.

#+begin_src emacs-lisp :tangle packages.el
(package! toc-org)
#+end_src

Package repository [[https://github.com/snosov1/toc-org][here]]. See configuration options and usage [[https://github.com/snosov1/toc-org#use][here]].
** TODO literate-calc-mode
Enable with ~literate-calc-minor-mode~. Use ~literate-calc-insert-results~ to copy results into buffer.

Package repository: [[https://github.com/sulami/literate-calc-mode.el][github]].

#+begin_src emacs-lisp :tangle packages.el
(package! literate-calc-mode)
#+end_src

#+begin_src emacs-lisp
(use-package literate-calc-mode
  :defer t)
#+end_src

See article [[https://blog.sulami.xyz/posts/literate-calc-mode/][here]] and repository [[https://github.com/sulami/literate-calc-mode.el][here]] in github.
** TODO org-pomodoro
Basic configuration:
#+begin_src emacs-lisp
(setq org-pomodoro-format "%s"
      org-pomodoro-start-sound-p t
      org-pomodoro-short-break-length 10)
#+end_src

=org-pomodoro= package uses =org-clock=. This latter shows the task title in the modeline, sometimes this title is lengthy making it hard to see the Pomodoro's timer.

#+begin_src emacs-lisp
(setq org-clock-clocked-in-display 'mode-line)
#+end_src

|-------------+--------------------------------------------|
| Value       | Description                                |
|-------------+--------------------------------------------|
| both        | displays in both mode line and frame title |
| mode-line   | displays only in mode line (default)       |
| frame-title | displays only in frame title               |
| nil         | current clock is not displayed             |
|-------------+--------------------------------------------|
I'm only showing the first 8 characters from the task. In most cases this is enough to show the JIRA ticket I'm working on.
#+begin_src emacs-lisp
(setq org-clock-heading-function
      (lambda ()
        (let ((str (nth 4 (org-heading-components))))
          (if (> (length str) 8)
              (substring str 0 8)))))
#+end_src
Source: [[https://stackoverflow.com/a/14527487][here]].

Configure bell sound for break and finish:
#+begin_src emacs-lisp
(setq me/org-pomodoro-bell-sound "~/.doom.d/resources/bell-ring-01.wav")
(setq org-pomodoro-finished-sound me/org-pomodoro-bell-sound
      org-pomodoro-start-sound me/org-pomodoro-bell-sound
      org-pomodoro-long-break-sound me/org-pomodoro-bell-sound
      org-pomodoro-short-break-sound me/org-pomodoro-bell-sound
      org-pomodoro-ticking-sound me/org-pomodoro-bell-sound
      org-pomodoro-overtime-sound me/org-pomodoro-bell-sound)

#+end_src

Configure volume, see github comment [[https://github.com/marcinkoziej/org-pomodoro/issues/29#issuecomment-129608240][here]]:
#+begin_src emacs-lisp
(setq me/org-pomodoro-sound-args "-volume 1.0")
(setq org-pomodoro-finished-sound-args me/org-pomodoro-sound-args
      org-pomodoro-long-break-sound-args me/org-pomodoro-sound-args
      org-pomodoro-start-sound-args me/org-pomodoro-sound-args
      org-pomodoro-short-break-sound-args me/org-pomodoro-sound-args
      org-pomodoro-ticking-sound-args me/org-pomodoro-sound-args)
#+end_src
** TODO ox-slack
#+begin_src emacs-lisp :tangle packages.el
(package! ox-slack)
#+end_src

* Terminal integration
There's several packages to integrate terminal-workflows into Emacs. Some of these are =shell= and =term=. I'll be using =vterm= and I'll referring to this package for the rest of this section.

=vterm= offers a fully featured terminal emulation layer for Emacs. It works by leveraging ~libvterm~ library, which powers xterm. Check [[https://www.youtube.com/watch?v=8oNycFLwKfE][this presentation]] for an introduction and walkthrough. Find more in [[https://emacsconf.org/2020/talks/30/][this talk]]. Find the main repository [[https://github.com/akermu/emacs-libvterm][here]].

Since it leverages ~libvterm~ it requires a extra steps for the installation. Check out the Doom Emacs' [[https://docs.doomemacs.org/latest/modules/term/vterm/][instructions]].

#+begin_src emacs-lisp
(use-package vterm
  :defer t
  :custom
  (vterm-shell "fish")
  (setq vterm-timer-delay 0))

(after! vterm
  (map! :map vterm-mode-map "M-v" 'vterm-yank)
  (map! :map vterm-mode-map "M-t" '+vterm/toggle)
  (map! :map vterm-mode-map "M-w" '+workspace/close-window-or-workspace))
#+end_src

Open termina in vsplit window:
#+begin_src emacs-lisp
(defun me/vterm-split-right ()
  "Create a new vterm window to the right of the current one."
  (interactive)
  (let* ((ignore-window-parameters t)
         (dedicated-p (window-dedicated-p)))
    (split-window-horizontally)
    (other-window 1)
    (+vterm/here default-directory)))

(map! :leader :desc "Open vterm vsplit" "o T" #'me/vterm-split-right)
#+end_src
* Other
** TODO elfeed
#+begin_src emacs-lisp :tangle packages.el
(package! elfeed)
(package! elfeed-goodies)
#+end_src
#+begin_src emacs-lisp
(defun me/elfeed-view ()
  (interactive)
  (elfeed-update)
  (elfeed-goodies/setup)
  (elfeed))
#+end_src

#+begin_src emacs-lisp
(use-package elfeed
  :defer t
  :config
  (add-hook 'elfeed-show-mode-hook #'elfeed-update)
  (add-hook  'elfeed-show-mode-hook 'variable-pitch-mode)
  (setq elfeed-feeds
      '(
        ("https://sachachua.com/blog/category/emacs-news/feed/" emacs)
        ("https://planet.emacslife.com/atom.xml" emacs)
        ("http://nedroid.com/feed/" webcomic)
        ("https://hnrss.org/frontpage" news)
        )))
#+end_src

** browse-url
#+begin_src emacs-lisp
(defmacro with-system (type &rest body)
  "Evaluate BODY if `system-type' equals TYPE."
  (declare (indent defun))
  `(when (eq system-type ',type)
     ,@body))
#+end_src
Source: https://stackoverflow.com/a/26137517

#+begin_src emacs-lisp
(setq browse-url-browser-function 'browse-url-generic)
(map! :leader :desc "Browse at remote" "c B" 'browse-at-remote)
#+end_src

Use different browsers depending on theme (similar to modus operandi / modus vivendi themes):
#+begin_src emacs-lisp
(with-system gnu/linux
    (setq me/chrome-bin-path "chrome")
    (setq me/firefox-bin-path "firefox"))

(with-system darwin
    (setq me/chrome-bin-path "/Applications/Google Chrome.app/Contents/MacOS/Google Chrome")
    (setq me/firefox-bin-path "/Applications/Firefox.app/Contents/MacOS/firefox"))
#+end_src

In the above code I'm using the =system-type= variable to determine what to assigned to the me/chrome / me/firefox variables. The =system-type= variable is described [[https://www.gnu.org/software/emacs/manual/html_node/elisp/System-Environment.html#index-system_002dtype][here]] together with this great snippet:

#+begin_quote
gnu/linux
A GNU/Linux system—that is, a variant GNU system, using the Linux kernel. (These systems are the ones people often call “Linux”, but actually Linux is just the kernel, not the whole system.)
#+end_quote

Automatically switch browser depending on OS appearance:
#+begin_src emacs-lisp
(defun me/switch-browser (appearance)
  "Switch browser, taking current system APPEARANCE into consideration."
  (pcase appearance
    ('light (setq browse-url-generic-program me/chrome-bin-path))
    ('dark (setq browse-url-generic-program me/firefox-bin-path))))

(add-hook 'ns-system-appearance-change-functions #'me/switch-browser)
#+end_src
** keyfreq
This package records the command frequency. I'm installing this since I want to improve the keybindings usage to have less typing.
#+begin_src emacs-lisp :tangle packages.el
(package! keyfreq)
#+end_src

#+begin_src emacs-lisp :tangle yes
(use-package keyfreq
  :config
    (keyfreq-mode 1)
    (keyfreq-autosave-mode 1))
#+end_src
